# Ergodeon

*Autonomous code orchestration*

## Суть проекта

Ergodeon - автономный AI-агент на Python для разработки программного обеспечения. Использует LLM через API OpenRouter для понимания инструкций пользователя и взаимодействия с операционной системой.

Ключевая особенность - способность планировать, выполнять инструменты (чтение/запись файлов, запуск команд) и поддерживать контекст диалога. При работе над проектом агент автоматически создаёт документацию (чеклист, walkthrough, план) в папке проекта в формате YAML + Markdown.

---

## Установка и запуск

Требуется Python 3.10+ и `uv`.

```bash
pip install uv
cp .env.example .env
# вставьте OPENROUTER_API_KEY в .env
./run_demo.sh
```

---

## Режимы запуска

### Обычный запуск

```bash
./run_demo.sh
```

Открывает интерактивный чат. Агент сам определяет намерение и выбирает флоу.

### Открыть существующий проект

```bash
./run_demo.sh --project ./projects/my-project
./run_demo.sh -p ./projects/my-project
```

Устанавливает активный проект при старте. Если в проекте найден прерванный пайплайн - предлагает продолжить автоматически.

### Сразу возобновить прерванный пайплайн

```bash
./run_demo.sh --resume ./projects/my-project
./run_demo.sh -r ./projects/my-project
```

Пропускает вступление, сразу показывает статус и запускает resume.

---

## Команды в чате

| Команда | Описание |
|---|---|
| `exit` / `quit` | Выход |
| `reset` | Сбросить контекст активного проекта и историю диалога |
| `project` | Показать текущий активный проект и его статус |
| `adopt <путь>` | Взять существующую папку как проект (без документов) |
| `resume [путь]` | Возобновить прерванный пайплайн |
| `analyze [путь]` | Проанализировать проект и сохранить analysis.md |

Если путь не указан в `resume` и `analyze` - используется текущий активный проект.

---

## Флоу работы с проектами

### Флоу 1 - Создать новый проект

Описываете задачу в чате. Агент определяет что это пайплайн, предлагает запустить, создаёт папку в `projects/`, проходит 7 этапов.

```
User: Launchpad-контракт на Solidity для Polygon с вайтлистом...
→ Агент: задача для пайплайна. Запустить? [y/n]
→ Создаёт projects/polygon-launchpad_1234567890/
→ Проходит этапы 1-7
→ При прерывании: статус сохранён, можно продолжить через resume
```

### Флоу 2 - Продолжить прерванный пайплайн

Если пайплайн был прерван (Ctrl+C, ошибка сети, таймаут) - агент сохраняет прогресс в `execution_log.yaml` после каждого шага. Продолжить можно тремя способами:

```bash
# При запуске
./run_demo.sh --resume ./projects/polygon-launchpad_1234567890

# Командой в чате
resume ./projects/polygon-launchpad_1234567890

# Естественным языком
User: продолжи выполнение ./projects/polygon-launchpad_1234567890
```

Агент покажет таблицу: сколько шагов выполнено, сколько осталось, какой следующий.

### Флоу 3 - Взять существующий проект без документов

Есть папка с кодом которую не создавал агент. Три способа открыть:

```bash
# При запуске
./run_demo.sh --project ./my-existing-app

# Командой в чате
adopt ./my-existing-app

# Естественным языком (агент распознаёт автоматически)
User: возьми проект ./my-existing-app
User: вот проект /home/user/my-app - поработай с ним
User: /home/user/my-app   ← просто путь к директории
```

После adopt агент предлагает три варианта:
- Проанализировать и сохранить анализ в `analysis.md`
- Запустить пайплайн (создать документы и план реализации)
- Просто работать в режиме чата (спрашивать, редактировать файлы)

### Флоу 4 - Анализ проекта

Проводит глубокий анализ кодовой базы и сохраняет результат в `analysis.md` внутри папки проекта. Анализ включает стек, архитектуру, точки входа, технический долг, рекомендации.

```bash
# Командой
analyze ./my-app

# Через adopt → выбрать вариант 1

# Естественным языком
User: проанализируй проект ./my-app и сохрани результат
User: сделай анализ /home/user/backend и создай отчёт
```

### Флоу 5 - Чат с активным проектом

После любого из флоу 1-4 агент знает активный проект и все файловые операции выполняет внутри него. Можно просто разговаривать:

```
User: что здесь не так с архитектурой?
User: добавь логирование в модуль payments
User: напиши тесты для функции calculate_fee
User: покажи мне файл contracts/Launchpad.sol
```

---

## Естественное определение намерения

Агент понимает намерение пользователя без знания команд. Примеры:

| Что написать | Что произойдёт |
|---|---|
| `возьми проект /path/to/app` | adopt |
| `вот проект /path` | adopt |
| `/home/user/my-app` _(просто путь)_ | adopt |
| `продолжи выполнение` | resume активного проекта |
| `возобнови пайплайн /path` | resume по пути |
| `проанализируй проект /path` | analyze |
| `сделай анализ и сохрани` | analyze активного проекта |
| `создай REST API на FastAPI...` | pipeline |

---

## Переменные окружения

| Переменная | Значение по умолчанию | Описание |
|---|---|---|
| `OPENROUTER_API_KEY` | — | API ключ OpenRouter (обязательно) |
| `OPENROUTER_MODEL` | `openai/gpt-4o` | Модель LLM |
| `AUTO_CONFIRM` | `false` | Автоподтверждение файловых операций без запроса |

`AUTO_CONFIRM=true` - агент не спрашивает подтверждение при `write_file`, `edit_file`, `execute_command` и других опасных операциях. Ревью документов всегда требует явного ответа независимо от этого флага.

---

## Пайплайн документооборота (7 этапов)

При создании нового проекта агент проходит 7 этапов. Документы хранятся в `флоу-разработки/стейдж-N/версия-N/` внутри папки проекта.

### Этап 1 - Парсинг запроса
Запрос преобразуется в структурированный формат: goal, actions, constraints, implicit_requirements, priority, scope. Если запрос размытый - агент задаёт уточняющие вопросы.

### Этапы 2-3 - Сканирование и вытяжка
`ProjectScanner` рекурсивно обходит проект (игнорирует `.git`, `node_modules`, `.venv`). Файлы категоризируются и приоритизируются. LLM генерирует Project Digest: стек, архитектура, зависимости, релевантные файлы, риски.

### Этап 4 - Генерация документов
Три документа генерируются последовательно (каждый зависит от предыдущего):

**checklist.yaml / checklist.md** - атомарные задачи с категориями (ANALYSIS, MODIFICATION, CREATION, DELETION, CONFIGURATION, VERIFICATION), зависимостями, критериями приёмки.

**walkthrough.yaml / walkthrough.md** - изменения по функциональным блокам с перекрёстными ссылками на checklist_ids.

**implementation_plan.yaml / implementation_plan.md** - шаги выполнения (max 12) с action_type (create_file, modify_file, delete_file, run_command, verify), целью и откатом.

### Этап 5 - Ревью
Агент ждёт обратную связь. Можно оставить `<!-- COMMENT: текст -->` прямо в `.md` файлах или написать комментарий в чате. Изменение чеклиста каскадно перегенерирует walkthrough и план.

### Этап 6 - Имплементация
Последовательное выполнение шагов. После каждого шага прогресс сохраняется в `execution_log.yaml` - прерывание не теряет выполненные шаги. При ошибке до 3 повторных попыток. Зависимые шаги блокируются при провале родителя.

### Этап 7 - Верификация
Итоговая статистика. Если >30% шагов провалились - `critical_failure`. При `partial_success` агент подсказывает команду для продолжения.

### Файлы в папке проекта

```
флоу-разработки/стейдж-1/версия-1/
  parsed_request.yaml      структурированный запрос
  project_digest.yaml      вытяжка проекта
  checklist.yaml           чеклист задач (машиночитаемый)
  checklist.md             чеклист задач (человекочитаемый, для комментариев)
  walkthrough.yaml
  walkthrough.md
  implementation_plan.yaml
  implementation_plan.md
  execution_log.yaml       лог выполнения с прогрессом (основа для resume)
  execution_log.md         лог выполнения (человекочитаемый)
  review_comments.md       файл для inline комментариев
```

YAML - основной формат данных. Markdown генерируется из YAML и предназначен для чтения и комментирования человеком. При resume читается YAML.

---

## Структура проекта

```
Ergodeon/
  src/openrouter_agent/
    agent/
      core.py          ядро агента, ReAct цикл, run_pipeline, resume_pipeline
      intent.py        классификация намерений
      memory.py        эпизодическая память (JSON, Jaccard similarity)
      planner.py       планировщик, валидация, авто-исправление
      sandbox.py       снимки рабочей директории
      prompts.py       промты для LLM (7 шт)
      config.py        конфигурация пайплайна
      scanner.py       сканнер проекта
      doc_generator.py генератор документов (YAML + MD)
    tools/
      base.py          BaseTool (msgspec)
      registry.py      реестр инструментов
      filesystem.py    файловая система (10 инструментов)
      system.py        системные команды (2 инструмента)
      web.py           веб (2 инструмента)
      code.py          анализ кода (1 инструмент)
      reasoning.py     мета-рассуждение (1 инструмент)
      json_edit.py     JSONPath редактор (1 инструмент)
    server/
      app.py           HTTP API (Litestar), endpoint /chat
    utils.py           find_balanced_json, load/save json/yaml, compute_diff
  demo/
    cli.py             интерактивный CLI (Rich)
  memory/
    episodes.json      персистентная память эпизодов
  projects/            созданные агентом проекты
  pyproject.toml
  run_demo.sh
  .env.example
```

---

## Инструменты агента

### Файловая система (10)

| Инструмент | Описание |
|---|---|
| `read_file` | Чтение файла, поддержка диапазонов строк и номеров |
| `write_file` | Создание/перезапись файла |
| `edit_file` | Замена точного вхождения текста |
| `edit_file_by_lines` | Замена диапазона строк |
| `multi_edit_file` | Серия замен в одном файле |
| `delete_file` | Удаление файла или директории |
| `move_file` | Перемещение/переименование |
| `list_directory` | Список файлов и папок |
| `get_file_info` | Метаданные файла |
| `search_files` | Поиск по glob-паттерну |

### Система (2)

| Инструмент | Описание |
|---|---|
| `execute_command` | Выполнение shell-команды с cwd и таймаутом |
| `get_current_directory` | Текущая рабочая директория |

### Веб (2)

| Инструмент | Описание |
|---|---|
| `web_fetch` | Скачивание содержимого страницы |
| `web_api` | HTTP-запрос к API |

### Анализ и рассуждение (3)

| Инструмент | Описание |
|---|---|
| `analyze_code` | Анализ структуры файла (Python AST, JS/TS regex) |
| `sequential_thinking` | Пошаговое рассуждение (мета-когнитивный) |
| `json_edit` | Редактирование JSON через JSONPath |

---

## Конфигурация пайплайна

| Параметр | Значение | Описание |
|---|---|---|
| `max_review_iterations` | 3 | Лимит итераций ревью |
| `max_retry_per_step` | 3 | Повторные попытки шага |
| `failed_tasks_threshold_percent` | 30 | Порог critical_failure |
| `temperature_analysis` | 0.1 | Температура парсинга запроса |
| `temperature_generation` | 0.3 | Температура генерации документов |
| `temperature_code` | 0.1 | Температура генерации кода |
| `max_files_to_read` | 50 | Лимит файлов для чтения при сканировании |
| `max_file_size_bytes` | 100000 | Лимит размера файла |

Параметры задаются через `PipelineConfig` или переменные окружения `PIPELINE_MAX_REVIEW`, `PIPELINE_MAX_RETRY`.

---

## Безопасность

Все файловые операции внутри пайплайна ограничены директорией проекта (`project_dir`). Попытка записи за пределы блокируется на уровне `_resolve_and_guard` до передачи инструменту. В режиме чата с активным проектом то же ограничение применяется через `active_project_dir`.

При `AUTO_CONFIRM=false` (по умолчанию) каждая опасная операция показывает инструмент, путь/команду и ждёт явного `y`. Спиннер останавливается перед запросом чтобы ввод не конкурировал с рендером терминала.

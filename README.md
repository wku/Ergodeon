# Ergodeon

*Autonomous code orchestration*

## Суть проекта

Ergodeon - автономный AI-агент на Python для разработки программного обеспечения. Использует LLM через API OpenRouter для понимания инструкций пользователя и взаимодействия с операционной системой.

Ключевая особенность агента - способность планировать, выполнять инструменты (чтение/запись файлов, запуск команд) и поддерживать контекст диалога. При работе над проектом агент автоматически создает документацию (чеклист, walkthrough, план) в папке проекта.

### Архитектура
Проект построен на стеке Python
- `AsyncOpenAI` - асинхронное взаимодействие с API
- `msgspec` - высокопроизводительная валидация и сериализация данных
- `uv` - менеджер пакетов и зависимостей
- `rich` - интерфейс командной строки (CLI)
- `litestar` - HTTP-сервер для API-режима
- 7-этапный пайплайн документооборота проектов
- Безопасность - подтверждение опасных операций, песочница, снимки

### Структура проекта

```
python_impl/
  src/openrouter_agent/
    agent/
      core.py          - ядро агента, цикл ReAct, run_pipeline (7 этапов)
      intent.py        - классификация намерений пользователя
      memory.py        - эпизодическая память (персистентная)
      planner.py       - планировщик задач, валидация, авто-исправление
      sandbox.py       - песочница, снимки рабочей директории
      prompts.py       - централизованные промты для LLM (7 шт)
      config.py        - конфигурация пайплайна
      scanner.py       - сканнер проекта (категоризация, приоритизация)
      doc_generator.py - генератор документов (чеклист, walkthrough, план)
    tools/
      base.py          - абстрактный базовый класс BaseTool
      registry.py      - реестр инструментов и генерация схем
      filesystem.py    - инструменты файловой системы (10 шт)
      system.py        - системные инструменты (2 шт)
      web.py           - веб-инструменты (2 шт)
      code.py          - анализ кода (1 шт)
      reasoning.py     - мета-когнитивное рассуждение (1 шт)
      json_edit.py     - редактирование JSON через JSONPath (1 шт)
    server/
      app.py           - HTTP API на Litestar, endpoint /chat
    utils/
      __init__.py      - find_balanced_json, load_json, save_json, compute_diff
  demo/
    cli.py             - интерактивный CLI на Rich
  pyproject.toml
  run_demo.sh
```

---

## Пайплайн документооборота проектов

При работе над проектом агент проходит 7 этапов, создавая и поддерживая документы в папке `project_docs/` внутри проекта.

### Этап 1. Парсинг запроса
Запрос пользователя преобразуется в структурированный формат
- goal, actions, constraints, implicit_requirements, priority, scope
- Если запрос размытый - агент формулирует уточняющие вопросы

### Этап 2-3. Исследование проекта и вытяжка
Сканирование кодовой базы через `ProjectScanner`
- Рекурсивный обход с фильтрацией (.git, node_modules, .venv и т.д.)
- Категоризация файлов (config, entry_point, routing, model, test, ...)
- Приоритизация для чтения (конфиги и точки входа первыми, затем по релевантности к запросу)
- Генерация Project Digest через LLM (стек, структура, зависимости, релевантные файлы, риски)

### Этап 4. Генерация 3 документов
Документы генерируются последовательно, каждый зависит от предыдущего

**checklist.md** - чеклист атомарных задач
- Категории: ANALYSIS, MODIFICATION, CREATION, DELETION, CONFIGURATION, VERIFICATION
- Для каждой задачи: id (формат CAT-NNN), описание, зависимости, критерий приемки

**walkthrough.md** - описание изменений по функциональным блокам
- Цель каждого блока, затрагиваемые файлы, описание изменений, риски
- Перекрестная связь с чеклистом (checklist_ids)

**implementation_plan.md** - пошаговый план выполнения
- Для каждого шага: action_type (create_file, modify_file, delete_file, run_command, verify), target, описание, откат
- Шаги верификации после каждого логического блока

### Этап 5. Ревью клиентом
Агент спрашивает обратную связь по документам
- Типы комментариев: approve, minor_edit, major_change, rejection
- Каскад зависимостей: изменение чеклиста -> перегенерация walkthrough и плана
- Лимит итераций ревью (по умолчанию 3)
- Формат комментариев в `review_comments.md`: `> COMMENT: текст`

### Этап 6. Имплементация
Последовательное выполнение шагов из плана
- Статусы задач: pending -> in_progress -> completed / failed / blocked / skipped
- Повторные попытки при ошибке (по умолчанию 3)
- Блокировка зависимых задач при провале
- Снимок проекта через Sandbox перед началом
- Лог выполнения в `execution_log.md`

### Этап 7. Финальная верификация
Проверка по чеклисту с итоговой статистикой
- Если >30% задач провалились - предложение отката к снимку
- Сохранение эпизода в память

### Документы в папке проекта

```
project_docs/
  parsed_request.json         - структурированный запрос
  project_digest.json         - вытяжка проекта
  checklist.md / .json        - чеклист задач
  walkthrough.md / .json      - описание изменений
  implementation_plan.md / .json - план выполнения
  execution_log.md            - лог выполнения
  review_comments.md          - комментарии клиента
```

---

## Механика работы (ReAct)

Базовый цикл агента (метод `chat()`)

### 1. Классификация намерения
При получении запроса `IntentClassifier` определяет тип задачи
- Двухуровневая классификация - fuzzy-поиск по ключевым словам + LLM fallback
- Типы - `create`, `edit`, `run`, `explain`, `test`, `optimize`

### 2. Поиск в памяти
`EpisodeMemory` проверяет наличие похожих прошлых задач (Jaccard similarity)

### 3. Выполнение
Цикл ReAct - LLM вызывает инструменты, агент выполняет их, результат возвращается в LLM
- Валидация аргументов через `msgspec`
- Подтверждение для опасных операций
- Авто-исправление ошибок через `Planner.suggest_fix`

### 4. Сохранение
Каждый запрос сохраняется как эпизод с intent, временем, превью ответа

---

## Установка и запуск

Требуется Python 3.10+ и `uv`.

```bash
pip install uv
export OPENROUTER_API_KEY=sk-or-v1-...
cd python_impl
./run_demo.sh
```

---

## Инструменты

### Файловая система (10)

| Инструмент | Описание |
|---|---|
| `read_file` | Чтение файла, поддержка диапазонов строк |
| `write_file` | Создание/перезапись файла |
| `edit_file` | Замена точного вхождения текста |
| `edit_file_by_lines` | Замена диапазона строк |
| `multi_edit_file` | Серия замен в одном файле |
| `delete_file` | Удаление файла или директории |
| `move_file` | Перемещение/переименование |
| `list_directory` | Список файлов и папок |
| `get_file_info` | Метаданные файла |
| `search_files` | Поиск по glob-паттерну |

### Система (2)

| Инструмент | Описание |
|---|---|
| `execute_command` | Выполнение shell-команды |
| `get_current_directory` | Текущая рабочая директория |

### Веб (2)

| Инструмент | Описание |
|---|---|
| `web_fetch` | Скачивание содержимого страницы |
| `web_api` | HTTP-запрос к API |

### Анализ и рассуждение (3)

| Инструмент | Описание |
|---|---|
| `analyze_code` | Анализ структуры файла (Python AST, JS/TS regex) |
| `sequential_thinking` | Мета-когнитивный инструмент для пошагового рассуждения |
| `json_edit` | Редактирование JSON через JSONPath |

---

## Конфигурация пайплайна

| Параметр | Значение | Описание |
|---|---|---|
| `max_review_iterations` | 3 | Лимит итераций ревью |
| `max_retry_per_step` | 3 | Повторные попытки шага |
| `failed_tasks_threshold_percent` | 30 | Порог для предложения отката |
| `snapshot_strategy` | directory_copy | Стратегия снимков |
| `temperature_analysis` | 0.1 | Температура для парсинга |
| `temperature_generation` | 0.3 | Температура для генерации документов |
| `temperature_code` | 0.1 | Температура для генерации кода |
| `max_files_to_read` | 50 | Лимит файлов для чтения |
| `max_file_size_bytes` | 100000 | Лимит размера файла |

Параметры задаются через `PipelineConfig` или переменные окружения (`PIPELINE_MAX_REVIEW`, `PIPELINE_MAX_RETRY`, `PIPELINE_LANG`).

---

## Архитектурные компоненты

### IntentClassifier (`agent/intent.py`)
Классификация намерений: create, edit, run, explain, test, optimize. Fuzzy-поиск + LLM fallback

### Planner (`agent/planner.py`)
Генерация планов, валидация (допустимые действия, безопасные пути, лимит 12 шагов), авто-исправление, оценка результатов (score 0.0-1.0)

### EpisodeMemory (`agent/memory.py`)
Персистентное JSON-хранилище эпизодов с поиском по Jaccard similarity

### Sandbox (`agent/sandbox.py`)
Снимки рабочей директории перед выполнением

### ProjectScanner (`agent/scanner.py`)
Сканирование проекта - обход, категоризация, приоритизация, чтение с лимитами

### DocumentGenerator (`agent/doc_generator.py`)
Генерация документов проекта через LLM, перекрестная валидация, ревью с каскадом зависимостей, логирование

### Утилиты (`utils/__init__.py`)
find_balanced_json, load_json, save_json, compute_diff

---

## Зависимости

| Пакет | Версия | Назначение |
|---|---|---|
| `litestar` | >=2.12.0 | HTTP-сервер |
| `uvicorn` | >=0.30.0 | ASGI-сервер |
| `pydantic` | >=2.7.0 | Валидация данных сервера |
| `msgspec` | >=0.18.6 | Валидация аргументов инструментов |
| `python-socketio` | >=5.11.0 | WebSocket |
| `rich` | >=13.7.0 | CLI-интерфейс |
| `openai` | >=1.30.0 | OpenAI-совместимый API-клиент |
| `python-dotenv` | >=1.0.1 | Переменные окружения |
| `tenacity` | >=8.3.0 | Retry-логика |
| `requests` | >=2.31.0 | HTTP-запросы |
| `jsonpath-ng` | >=1.6.0 | JSONPath |

# Детальное описание этапов пайплайна

## Этап 1. Парсинг запроса клиента

### Вход
Свободный текст от клиента на любом языке

### Логика работы
Агент получает запрос и отправляет его в LLM с промтом для структуризации. LLM должен извлечь явные цели, неявные требования (то что клиент подразумевает но не написал), технические ограничения, приоритеты если они указаны

Если запрос слишком размытый и не позволяет определить scope работы, агент должен сформулировать уточняющие вопросы и вернуть их клиенту до начала следующего этапа

### Выход
Структурированный JSON с полями goal, actions, constraints, implicit_requirements, priority, scope

### Критерии перехода к следующему этапу
Все обязательные поля заполнены. Поле actions содержит хотя бы одно конкретное действие. Scope определён и не противоречит actions

---

## Этап 2. Исследование проекта

### Вход
Путь к директории проекта или доступ к репозиторию

### Логика работы

Шаг 2.1. Получение дерева файлов проекта. Рекурсивный обход директории с исключением игнорируемых путей. Результат сохраняется как плоский список путей с метаданными (размер, расширение)

Шаг 2.2. Классификация файлов по категориям. Каждый файл получает категорию из набора (config, entry_point, routing, model, service, utility, test, static, docs, other). Классификация происходит по имени файла, расширению и расположению в структуре

Шаг 2.3. Приоритизация для чтения. На основе категории и релевантности к запросу клиента формируется очередь чтения. Бюджет на чтение ограничен размером контекстного окна LLM минус запас на генерацию

Шаг 2.4. Чтение файлов. Файлы читаются в порядке приоритета. Для каждого файла создаётся краткая аннотация что он содержит и как связан с запросом клиента. Если файл слишком большой, читается только начало (импорты, определения классов, сигнатуры функций)

Шаг 2.5. Анализ зависимостей. Из конфигурационных файлов извлекается список зависимостей. Определяются версии, потенциальные конфликты, устаревшие пакеты если это видно

### Выход
Project Digest в стандартизированном формате

### Критерии перехода
Вытяжка содержит информацию о стеке, структуре и ключевых файлах. Есть хотя бы одна точка входа. Определены зависимости проекта

---

## Этап 3. Генерация вытяжки

### Вход
Результаты исследования из Этапа 2 + структурированный запрос из Этапа 1

### Логика работы
LLM получает все собранные данные и формирует сжатое представление проекта, сфокусированное на том что релевантно запросу клиента. Это не просто копирование данных из Этапа 2, а их переработка с точки зрения конкретной задачи

Вытяжка должна явно указать какие части проекта будут затронуты, какие зависимости между компонентами существуют, где могут быть риски при внесении изменений

### Выход
Финальный Project Digest, готовый к передаче в промты генерации документов

---

## Этап 4. Генерация трёх документов

### Последовательность генерации

Документы генерируются строго последовательно, каждый следующий получает на вход предыдущие

**4.1 Чеклист задач**
Вход получает Project Digest + структурированный запрос. Промт описан в файле промтов. На выходе структурированный список задач с категориями, зависимостями и критериями приёмки

**4.2 Walkthrough**
Вход получает Project Digest + структурированный запрос + чеклист. Промт описан в файле промтов. На выходе документ с описанием каждого изменения в контексте проекта

**4.3 План имплементации**
Вход получает всё предыдущее. Промт описан в файле промтов. На выходе пошаговый план с конкретными действиями над файлами и верификацией

### Валидация документов

После генерации каждого документа агент проверяет его на внутреннюю согласованность. Каждый пункт walkthrough должен соответствовать минимум одному пункту чеклиста. Каждое действие в плане имплементации должно быть отражено в walkthrough. Не должно быть "висящих" пунктов в чеклисте которые не покрыты планом

Если валидация не проходит, документ перегенерируется с указанием конкретных расхождений

### Выход
Три согласованных документа, готовых к ревью клиентом

---

## Этап 5. Ревью клиентом

### Вход
Три сгенерированных документа, представленных клиенту

### Логика работы

Клиент получает документы и может оставить комментарии к каждому. Комментарии могут быть четырёх типов

Одобрение без замечаний. Документ принимается как есть

Мелкие правки. Конкретные изменения в формулировках, приоритетах, порядке задач. Агент вносит правки без полной перегенерации

Существенные замечания. Клиент хочет изменить scope, добавить или убрать задачи, пересмотреть подход. Агент перегенерирует затронутые документы и все зависящие от них

Отклонение. Клиент хочет начать заново с другим запросом. Агент возвращается к Этапу 1

### Обработка комментариев

Агент парсит комментарии клиента через LLM, определяет тип каждого комментария, формирует список изменений, применяет изменения к документам, предоставляет обновлённые документы на повторное ревью

Максимальное количество итераций ревью ограничивается конфигурацией (рекомендуется 3 итерации). После превышения лимита агент уведомляет что нужно переформулировать исходный запрос

### Выход
Три утверждённых документа с отметкой "approved" от клиента

### Критерии перехода
Клиент явно подтвердил все три документа. Нет открытых комментариев

---

## Этап 6. Имплементация

### Вход
Утверждённый план имплементации + кодовая база проекта

### Логика работы

Шаг 6.1. Парсинг плана. Агент разбирает план имплементации в список упорядоченных задач. Каждая задача получает статус "pending"

Шаг 6.2. Предварительная проверка. Перед началом работы агент проверяет что состояние проекта не изменилось с момента анализа. Если файлы изменились, агент уведомляет клиента и может потребоваться обновление плана

Шаг 6.3. Последовательное выполнение. Для каждой задачи из плана агент определяет тип операции (создать файл, изменить файл, удалить файл, выполнить команду). Формирует промт для LLM с контекстом задачи и содержимым затрагиваемых файлов. Получает от LLM результат (код, конфигурацию, команду). Применяет результат к проекту. Выполняет верификацию задачи

Шаг 6.4. Верификация каждого шага. После каждой задачи агент проверяет что файл синтаксически валиден (для кода), что изменение не сломало зависимости, что тесты проходят если они есть и если это предусмотрено планом

Шаг 6.5. Обработка ошибок при имплементации. Если задача не выполнена с первой попытки, агент делает до 3 повторных попыток с модифицированным промтом. Если после 3 попыток задача не выполнена, агент отмечает её как "failed", логирует причину и переходит к следующей задаче если она не зависит от провалившейся. Если зависит, вся цепочка зависимых задач отмечается как "blocked"

### Выход
Обновлённая кодовая база + лог выполнения

---

## Этап 7. Финальная верификация и отчёт

### Вход
Обновлённая кодовая база + лог выполнения + утверждённые документы

### Логика работы

Агент проходит по чеклисту и для каждого пункта проверяет выполнен ли он. Формирует итоговый отчёт с разбивкой по статусам (completed, failed, blocked, skipped)

Если есть провалившиеся задачи, отчёт содержит описание проблем и рекомендации по ручному исправлению

### Выход
Финальный отчёт для клиента с результатами имплементации

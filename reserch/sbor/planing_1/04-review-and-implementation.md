# Цикл ревью и логика имплементации

## Цикл ревью клиентом

### Модель взаимодействия

Клиент получает три документа одновременно. Может комментировать каждый по отдельности или все сразу. Агент не начинает имплементацию пока все три документа не получат статус "approved"

### Алгоритм обработки ревью

```
Получить комментарии клиента
    |
    v
Парсинг через Промт 5
    |
    v
Определить overall_status
    |
    +-- "approved" --> перейти к имплементации
    |
    +-- "rejected" --> вернуться к Этапу 1 (новый запрос)
    |
    +-- "needs_revision"
            |
            v
        Определить scope изменений
            |
            +-- только minor_edit
            |       |
            |       v
            |   Точечные правки в документах
            |   Без перегенерации
            |       |
            |       v
            |   Отправить обновлённые документы клиенту
            |
            +-- есть major_change
                    |
                    v
                Определить каскад зависимостей
                    |
                    +-- Изменился чеклист
                    |       --> перегенерировать walkthrough и план
                    |
                    +-- Изменился walkthrough
                    |       --> перегенерировать план
                    |
                    +-- Изменился только план
                            --> перегенерировать только план
                    |
                    v
                Отправить обновлённые документы клиенту
```

### Каскад зависимостей между документами

Чеклист является корневым документом. Изменение в чеклисте автоматически требует обновления walkthrough и плана имплементации

Walkthrough зависит от чеклиста. Изменение в walkthrough требует обновления плана имплементации но не чеклиста

План имплементации зависит от обоих предыдущих документов. Изменение в плане не требует обновления чеклиста и walkthrough

### Ограничения цикла ревью

Максимум 3 итерации ревью на один запрос. После третьей итерации если документы всё ещё не утверждены, агент предлагает клиенту переформулировать исходный запрос или разбить его на более мелкие подзадачи

Каждая итерация ревью полностью логируется для аудита

---

## Логика имплементации

### Жизненный цикл задачи

Каждая задача из чеклиста проходит через следующие статусы

```
pending --> in_progress --> completed
                |
                +--> failed --> (retry до 3 раз)
                |                   |
                |                   +--> permanently_failed
                |
                +--> blocked (зависимость провалилась)
                |
                +--> skipped (по решению агента или клиента)
```

### Порядок выполнения

Агент выполняет шаги из плана имплементации строго последовательно. Перед выполнением каждого шага проверяется что все зависимости (depends_on из чеклиста) имеют статус "completed"

Если зависимость имеет статус "failed" или "permanently_failed", текущий шаг получает статус "blocked" и агент переходит к следующему независимому шагу

### Контекст между шагами

Агент ведёт лог выполнения (execution_log) который содержит для каждого выполненного шага номер шага, статус, время выполнения, изменённые файлы, ошибки если были

Этот лог передаётся в промт выполнения каждого следующего шага чтобы LLM имел контекст что уже было сделано

### Стратегия отката

Перед началом имплементации агент создаёт снимок текущего состояния проекта (snapshot). Это может быть git stash, архив или копия директории в зависимости от конфигурации

Если имплементация завершилась с критическими ошибками (более 30% задач failed), агент предлагает откатить все изменения к снимку

### Верификация

После выполнения всех шагов агент проводит финальную верификацию по двум направлениям

Автоматическая проверка запускает тесты если они есть, проверяет синтаксис изменённых файлов, проверяет что зависимости установлены, пытается собрать/запустить проект

Сверка с чеклистом проходит по каждому пункту чеклиста и проверяет что критерий приёмки выполнен

### Финальный отчёт

Отчёт содержит общую статистику (сколько задач выполнено, провалено, заблокировано), детали по каждой задаче, список файлов которые были изменены/созданы/удалены, рекомендации по ручной проверке, известные проблемы если есть

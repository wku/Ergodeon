# Архитектура агентского пайплайна 

## Общая концепция

Агентский код принимает на вход запрос клиента и кодовую базу проекта, проходит через серию этапов анализа и планирования, генерирует три документа, предоставляет их клиенту на ревью, и после утверждения запускает имплементацию

## Схема потока данных

```
Запрос клиента + Кодовая база
        |
        v
  [Этап 1] Парсинг запроса клиента
        |
        v
  [Этап 2] Исследование проекта
        |
        v
  [Этап 3] Генерация вытяжки (Project Digest)
        |
        v
  [Этап 4] Генерация трёх документов
        |   - Чеклист задач
        |   - Walkthrough
        |   - План имплементации
        |
        v
  [Этап 5] Ревью клиентом
        |   - Комментарии и правки
        |   - Итерация (возврат к Этапу 4 если нужно)
        |
        v
  [Этап 6] Имплементация
        |   - Последовательное выполнение задач
        |   - Верификация каждого шага
        |
        v
  [Этап 7] Финальная верификация и отчёт
```

## Компоненты системы

### Оркестратор (Agent Controller)

Центральный модуль который управляет всем потоком. Принимает входные данные, вызывает нужные этапы в правильной последовательности, хранит промежуточное состояние между этапами, обрабатывает обратную связь от клиента

Состояние агента между этапами хранится в контексте сессии. Контекст включает в себя исходный запрос, вытяжку проекта, сгенерированные документы, комментарии клиента и текущий прогресс имплементации

### Модуль исследования проекта (Project Scanner)

Отвечает за получение структуры файлов, приоритизацию файлов для чтения, извлечение содержимого ключевых файлов, формирование стандартизированной вытяжки

Логика приоритизации файлов для чтения работает по следующим правилам. Сначала читаются конфигурационные файлы (package.json, requirements.txt, docker-compose, .env.example, Makefile). Затем точки входа приложения (main, app, index, launcher). Далее файлы маршрутизации и API-слой. После этого модели данных и схемы. И в последнюю очередь остальные файлы по релевантности к запросу клиента

Фильтрация исключает из анализа node_modules, .git, __pycache__, .env с реальными секретами, бинарные файлы, медиа-ассеты

### Модуль генерации документов (Document Generator)

Три отдельных промта для генерации каждого документа. Каждый промт получает на вход вытяжку проекта и структурированный запрос клиента. Документы генерируются последовательно, потому что walkthrough зависит от чеклиста, а план имплементации зависит от обоих

### Модуль ревью (Review Handler)

Принимает комментарии клиента к каждому из трёх документов. Определяет какие части документов нужно пересгенерировать. Запускает повторную генерацию только затронутых секций. Предоставляет обновлённые документы на повторное ревью

### Модуль имплементации (Implementation Engine)

Получает утверждённый план имплементации. Последовательно выполняет задачи из чеклиста. После каждой задачи проводит верификацию. В случае ошибки может откатить изменения и попробовать альтернативный подход. Ведёт лог выполненных действий

## Форматы данных между этапами

### Структурированный запрос клиента (после парсинга)

```
{
  "goal": "краткое описание цели",
  "actions": ["конкретное действие 1", "конкретное действие 2"],
  "constraints": ["ограничение 1", "ограничение 2"],
  "implicit_requirements": ["выведенное требование 1"],
  "priority": "high/medium/low",
  "scope": "описание границ задачи"
}
```

### Вытяжка проекта (Project Digest)

```
{
  "project_name": "название",
  "stack": {
    "language": "Python 3.11",
    "frameworks": ["Litestar", "SQLAlchemy"],
    "infrastructure": ["Docker", "PostgreSQL"]
  },
  "structure": {
    "entry_points": ["файл1", "файл2"],
    "config_files": ["файл1", "файл2"],
    "key_modules": ["модуль1", "модуль2"]
  },
  "dependencies": ["зависимость1", "зависимость2"],
  "architecture_notes": "краткое описание архитектуры",
  "relevant_files": {
    "path/to/file.py": "краткое описание содержимого и релевантности"
  },
  "potential_issues": ["проблема1", "проблема2"]
}
```

## Обработка ошибок

На каждом этапе агент должен уметь обрабатывать ситуации когда LLM возвращает невалидный формат, когда файл проекта не читается или повреждён, когда клиент даёт противоречивые комментарии, когда имплементация ломает существующий функционал

Стратегия обработки для каждого случая описана в файле обработки ошибок отдельно

# Конфигурация и обработка ошибок

## Конфигурация агента

### Параметры пайплайна

```
max_review_iterations: 3
max_retry_per_step: 3
failed_tasks_threshold_percent: 30
snapshot_strategy: "archive" | "git_stash" | "directory_copy"
output_language: "ru"
```

### Параметры LLM

```
model: "название модели"
temperature_analysis: 0.1    // низкая для парсинга и анализа
temperature_generation: 0.3  // умеренная для генерации документов
temperature_code: 0.1        // низкая для генерации кода
max_tokens_per_call: 4096
context_window_budget: 128000
reserved_for_output: 16000
```

### Параметры исследования проекта

```
max_file_size_bytes: 100000       // файлы больше этого читаются частично
max_files_to_read: 50             // лимит на количество файлов для чтения
ignored_directories: [
  "node_modules", ".git", "__pycache__", 
  ".venv", "venv", "dist", "build",
  ".next", ".nuxt", "coverage"
]
ignored_extensions: [
  ".pyc", ".pyo", ".so", ".dylib",
  ".jpg", ".png", ".gif", ".svg", ".ico",
  ".woff", ".woff2", ".ttf", ".eot",
  ".mp3", ".mp4", ".avi"
]
priority_files: [
  "package.json", "requirements.txt", "pyproject.toml",
  "Cargo.toml", "go.mod", "Gemfile",
  "Dockerfile", "docker-compose.yml", "docker-compose.yaml",
  "Makefile", ".env.example", "tsconfig.json",
  "README.md", "README.rst"
]
```

---

## Обработка ошибок

### Ошибки на этапе парсинга запроса

Если LLM возвращает невалидный JSON, агент делает повторный вызов с тем же промтом и указанием на ошибку формата. Максимум 3 попытки. Если после 3 попыток формат невалиден, агент возвращает клиенту сообщение о технической ошибке

Если запрос клиента на незнакомом языке, агент пытается обработать как есть. LLM как правило справляется с мультиязычным вводом. Если результат парсинга неадекватен, агент запрашивает уточнение у клиента

### Ошибки на этапе исследования проекта

Если директория проекта недоступна или пуста, агент останавливается и уведомляет клиента

Если файл не читается (права доступа, кодировка), агент пропускает его и добавляет заметку в вытяжку что файл был недоступен

Если проект слишком большой и не помещается в бюджет контекстного окна, агент читает только файлы из priority_files и файлы релевантные запросу клиента. В вытяжке указывается что анализ был неполным

### Ошибки на этапе генерации документов

Если LLM генерирует документ который не проходит внутреннюю валидацию (есть пункты чеклиста не покрытые walkthrough, есть шаги плана без привязки к чеклисту), агент перегенерирует с указанием конкретных расхождений

Если документы противоречат друг другу, приоритет имеет чеклист как корневой документ. Walkthrough и план перегенерируются

### Ошибки на этапе имплементации

Если LLM генерирует невалидный код, агент проверяет синтаксис, сообщает LLM об ошибке и запрашивает исправленную версию

Если изменение ломает существующий код (тесты падают, сборка не проходит), агент откатывает последнее изменение и пробует альтернативный подход

Если файл который нужно изменить не существует или был перемещён, агент ищет файл по имени в дереве проекта. Если не найден, отмечает задачу как failed с описанием проблемы

### Общие правила обработки ошибок

Все ошибки логируются с таймстампом, этапом, описанием и стектрейсом если применимо

Агент никогда не останавливается молча. Каждая ошибка либо обрабатывается автоматически, либо эскалируется клиенту с описанием проблемы и вариантами действий

Критические ошибки (невозможность прочитать проект, невозможность связаться с LLM, коррупция данных сессии) приводят к остановке пайплайна с полным отчётом о состоянии
